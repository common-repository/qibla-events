var DlMedia=DlMedia||{};(function(DlMedia,wp){"use strict";if(typeof wp.media==="undefined"){return}var Select=wp.media.view.MediaFrame.Select,Library=wp.media.controller.Library,l10n=wp.media.view.l10n;DlMedia.Gallery=Select.extend({initialize:function(){_.defaults(this.options,{multiple:true,editing:false,state:"gallery",metadata:{}});Select.prototype.initialize.apply(this,arguments);this.createIframeStates()},createStates:function(){var options=this.options;this.states.add([new Library({id:"gallery",title:l10n.createGalleryTitle,priority:40,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:false,library:wp.media.query(_.defaults({type:"image"},options.library))}),new wp.media.controller.GalleryEdit({library:options.selection,editing:options.editing,menu:"gallery"}),new wp.media.controller.GalleryAdd])},bindHandlers:function(){var handlers;Select.prototype.bindHandlers.apply(this,arguments);this.on("menu:create:gallery",this.createMenu,this);this.on("toolbar:create:main-gallery",this.createToolbar,this);handlers={menu:{default:"galleryMenu",gallery:"galleryMenu"},toolbar:{"main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar"}};_.each(handlers,function(regionHandlers,region){_.each(regionHandlers,function(callback,handler){this.on(region+":render:"+handler,this[callback],this)},this)},this)},galleryMenu:function(view){var lastState=this.lastState(),previous=lastState&&lastState.id,frame=this;view.set({cancel:{text:l10n.cancelGalleryTitle,priority:20,click:function(){if(previous){frame.setState(previous)}else{frame.close()}this.controller.modal.focusManager.focus()}},separateCancel:new wp.media.View({className:"separator",priority:40})})},selectionStatusToolbar:function(view){var editable=this.state().get("editable");view.set("selection",new wp.media.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:editable&&function(){this.controller.content.mode("edit-selection")}}).render())},mainGalleryToolbar:function(view){var controller=this;this.selectionStatusToolbar(view);view.set("gallery",{style:"primary",text:l10n.createNewGallery,priority:60,requires:{selection:true},click:function(){var selection=controller.state().get("selection"),edit=controller.state("gallery-edit"),models=selection.where({type:"image"});edit.set("library",new wp.media.model.Selection(models,{props:selection.props.toJSON(),multiple:true}));this.controller.setState("gallery-edit");document.querySelector(".gallery-settings").style.display="none";this.controller.modal.focusManager.focus()}})},galleryEditToolbar:function(){var editing=this.state().get("editing");this.toolbar.set(new wp.media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:editing?l10n.updateGallery:l10n.insertGallery,priority:80,requires:{library:true},click:function(){var controller=this.controller,state=controller.state();controller.close();state.trigger("select",state.get("library"));controller.setState(controller.options.state);controller.reset()}}}}))},galleryAddToolbar:function(){this.toolbar.set(new wp.media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:l10n.addToGallery,priority:80,requires:{selection:true},click:function(){var controller=this.controller,state=controller.state(),edit=controller.state("gallery-edit");edit.get("library").add(state.get("selection").models);state.trigger("reset");controller.setState("gallery-edit")}}}}))}})})(DlMedia,window.wp);