(function(_,DlMedia,wp){"use strict";var frame,inputs=document.querySelectorAll('[data-type="media-uploader"]');if(!inputs.length){return}function inGallery(attachment,input){return-1!==_.indexOf(attachment.id,getGallery(input))}function getGallery(input){var g=input.getAttribute("value");if(!g){return[]}var list=[];_.forEach(g.split(","),function(id){list.push(parseInt(id))});return list}function setRemoveBtn(wrapper,input){var rBtn=document.createElement("a");rBtn.classList.add("dl-media-rm-btn");rBtn.setAttribute("data-dlmime","image");rBtn.innerHTML='<i class="la la-close"></i><span class="dl-media-rm-btn__label">Remove</span>';wrapper.appendChild(rBtn);rBtn.addEventListener("click",function(e){removeAttachment.call(rBtn,e,input)})}function buildImageElement(attachment,wrapper,isMultiple,input){if(typeof attachment!=="object"){return}var wrapperSelector=isMultiple?".dl-media-gallery":".dl-media-img-wrapper",imageWrapper=wrapper.querySelector(wrapperSelector);if(!imageWrapper){imageWrapper=document.createElement("div");imageWrapper.classList.add("dl-media-gallery");wrapper.appendChild(imageWrapper)}if(!isMultiple&&imageWrapper){imageWrapper.remove();imageWrapper=null}if(!imageWrapper||isMultiple){imageWrapper=document.createElement("div");imageWrapper.classList.add("dl-media-img-wrapper")}imageWrapper.innerHTML='<img class="dl-media-attachment" data-id="'+attachment.id+'" src="'+attachment.url+'" alt="" style="max-width:100%; width:150px" />';if(isMultiple){wrapper.querySelector(wrapperSelector).appendChild(imageWrapper)}else{wrapper.appendChild(imageWrapper)}setRemoveBtn(imageWrapper,input)}function addAttachment(e,currInput){e.preventDefault();e.stopPropagation();var isMultiple="yes"===this.getAttribute("data-multiple"),wrapper=this.parentElement;if(isMultiple){frame=new DlMedia.Gallery}else{frame=wp.media({title:this.getAttribute("data-mediatitle"),multiple:false})}frame.on("select",function(){var attachments;if(isMultiple){attachments=frame.state().get("library").toJSON()}else{attachments=[frame.state().get("selection").first().toJSON()]}_.forEach(attachments,function(attachment){switch(this.getAttribute("data-dlmime")){case"image":var value=attachment.id;if(isMultiple){var values=currInput.getAttribute("value");values=_.unique(_.union(values.split(","),[value]));value=_.filter(values,function(val){return parseInt(val)});if(!inGallery(attachment,currInput)){buildImageElement(attachment,wrapper,isMultiple,currInput)}value=value.join(",")}else{buildImageElement(attachment,wrapper,isMultiple,currInput)}currInput.setAttribute("value",value);if(!isMultiple){this.style.display="none"}break;default:break}}.bind(this))}.bind(this));frame.open()}function removeAttachment(e,input){e.preventDefault();e.stopImmediatePropagation();var isMultiple="yes"===e.target.getAttribute("data-multiple");switch(this.getAttribute("data-dlmime")){case"image":var currAttach=e.target.previousElementSibling;if(!currAttach){break}var inputValues=input.getAttribute("value").split(","),index=inputValues.indexOf(currAttach.getAttribute("data-id"));if(-1!==index){inputValues.splice(index,1)}input.setAttribute("value",inputValues.join(","));this.parentElement.remove();if(!isMultiple){input.nextElementSibling.style.display="block"}break;default:break}}_.forEach(inputs,function(input){var addBtn=input.nextElementSibling;input.style.display="none";addBtn.addEventListener("click",function(e){addAttachment.call(this,e,input)});var label=document.querySelector('label[for="'+input.getAttribute("id")+'"]');if(label){label.addEventListener("click",function(e){addAttachment.call(addBtn,e,input)})}_.forEach(input.parentElement.querySelectorAll(".dl-media-img-wrapper"),function(wrapper){setRemoveBtn(wrapper,input)})})})(_,DlMedia,window.wp);