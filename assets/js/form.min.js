window.DL=window.DL||{};window.DlTypes=window.DlTypes||{};(function(_,ClassList,$,dllocalized,dlformlocalized,DL,DlTypes){"use strict";DL.Form={getForm:function(form,options){var FormHandler={addListener:function(obj,event,callback,options,extra){if(!obj||_.isArray(obj)){throw"Invalid Object on addListener."}if(!_.isFunction(callback)){throw"Invalid callback on addListener."}obj.addEventListener(event,function(e){callback.call(this,e,extra)}.bind(this),options);return this},dispatch:function(eventName,data){var customEvent=new CustomEvent(eventName,{detail:data});this.form.dispatchEvent(customEvent)},getFormHiddenFields:function(){var fields=this.form.querySelectorAll('input[type="hidden"]'),hiddenInputs={};if(fields.length){_.forEach(fields,function(field){hiddenInputs[field.getAttribute("name")]=field.value})}return hiddenInputs},setInvalidDescriptionForField:function(element,itemData){var invalidDesc=element.parentNode.querySelector("."+itemData.containerClass[0]+"__invalid-description");if(invalidDesc){invalidDesc.remove()}invalidDesc=document.createElement("p");invalidDesc.classList.add(itemData.containerClass[0]+"__invalid-description");invalidDesc.innerText=itemData.invalidDescription.replace(/<[^>]+>/gi,"");element.parentNode.setAttribute("class",itemData.containerClass.join(" "));element.parentNode.appendChild(invalidDesc)},errorResponseHandler:function(error){try{var responseJson=error.responseJSON.data;if(!_.isEmpty(responseJson)){_.forEach(responseJson.data,function(item){var element=document.querySelector(item.selector);if(element){this.setInvalidDescriptionForField(element,item)}}.bind(this))}this.showAlert(responseJson.message,"error",["la","la-times"],true)}catch(e){this.showAlert(window.dlformlocalized.unknownError,"error",["la","la-times"],true)}this.toggleLoader()},successResponseHandler:function(success){var response=success.data;if(this.dropZone.inputs.length){var eventDetail=_.extend({dlajax_action:"store_media_file",dropzoneCb:[{name:"sending",cb:function(file,xhr,formData){_.forEach(this.getFormHiddenFields(),function(value,key){formData.append(key,value)})}.bind(this)}]},this.getFormHiddenFields());this.dispatch("ajax-form-submit-files",eventDetail)}else{this.toggleLoader();this.showAlert(response.message,"success",["la","la-check"],true)}},showAlert:function(message,type,iconClass,dismissable){var alertTmpl=document.querySelector("#dlalert-tmpl");if(alertTmpl){var alert=this.form.parentNode.querySelector(".dlalert");if(alert){alert.remove()}var tmpl=_.template(alertTmpl.innerHTML);var templateObj={type:type,message:message,icon:{classList:iconClass.join(" ")}};var tmplCompiled=tmpl(templateObj);this.form.insertAdjacentHTML("beforebegin",tmplCompiled);if(dismissable){setTimeout(function(){$(this.form.parentNode.querySelector(".dlalert")).slideUp()}.bind(this),4e3)}}},toggleLoader:function(){var submit=this.form.querySelector('input[type="submit"]');DL.Utils.UI.toggleLoader(submit,function(){if(this.options.scrollOnTopAfterSubmit){this.scrollOnTopOfForm()}}.bind(this),function(){$(submit).stop(true,true).fadeOut()})},scrollOnTopOfForm:function(){var _self=this;$("html,body").animate({scrollTop:_self.form.parentNode.offsetTop},1600)},validateDropzoneFiles:function(){var isValid=true,currentFile=null,input=null;for(var c=0;c<this.dropZone.dropzoneCollection.length;++c){currentFile=this.dropZone.dropzoneCollection[c];input=currentFile.element.firstElementChild;if(currentFile.getRejectedFiles().length){this.showAlert(window.dlformlocalized.rejectedFiles,"error",["la","la-times"],true);isValid=false;break}else if(input.required&&!currentFile.files.length){this.showAlert(window.dlformlocalized.missedFile,"error",["la","la-times"],true);input.parentNode.parentNode.classList.add("is-invalid");isValid=false;break}}if(!isValid){this.scrollOnTopOfForm()}return isValid},submit:function(evt){evt.preventDefault();evt.stopPropagation();if(!this.validateDropzoneFiles()){return}if(!this.options.ajaxAction){throw"Ajax action not set. You must set an action to send data via ajax."}var data={dlajax_action:this.options.ajaxAction,enc_data:$(this.form).serialize(),extra_data:{fields:this.options.extraFields}};$.ajax(window.dllocalized.site_url+"/index.php",_.extend({method:"post",data:data},{beforeSend:this.options.ajaxBeforeSendCb.bind(this),error:this.options.ajaxErrorCb.bind(this),success:this.options.ajaxSuccessCb.bind(this)}))},init:function(){this.addListener(this.form,"submit",this.submit);this.dropZone.init();if(!_.isUndefined(this.options.onInit)&&_.isFunction(this.options.onInit)){this.options.onInit.call(this)}},construct:function(form,options){_.bindAll(this,"submit","showAlert","errorResponseHandler","successResponseHandler","toggleLoader","scrollOnTopOfForm","dispatch","setInvalidDescriptionForField");this.form=form;this.dropZone=DlTypes.getDropzone(this.form);this.options=_.extend({scrollOnTopAfterSubmit:true,ajaxBeforeSendCb:this.toggleLoader,ajaxErrorCb:this.errorResponseHandler,ajaxSuccessCb:this.successResponseHandler,extraFields:{},onInit:null},options);return this}};return FormHandler.construct(form,options)}}})(_,window.ClassList,window.jQuery,window.dllocalized,window.dlformlocalized,window.DL,window.DlTypes);