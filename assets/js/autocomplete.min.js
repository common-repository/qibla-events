window.DL=window.DL||{};(function(_,$,DL,dllocalized){"use strict";$.Autocomplete.prototype=_.extend($.Autocomplete.prototype,{setListeners:function(){var that=this;$(window).on("resize.autocomplete",that.fixPositionCapture);this.el.on("keydown.autocomplete",that.onKeyPress.bind(this));this.el.on("keyup.autocomplete",that.onKeyUp.bind(this));this.el.on("blur.autocomplete",that.onBlur.bind(this));this.el.on("focus.autocomplete",that.onFocus.bind(this));this.el.on("change.autocomplete",that.onKeyUp.bind(this));this.el.on("input.autocomplete",that.onKeyUp.bind(this));if(!_.isUndefined(that.initialSuggestions)&&that.initialSuggestions.length){that.el.on("click.autocomplete focus.autocomplete input.autocomplete",function(){if(""===this.value){that.suggest(that.initialSuggestions)}})}},initialize:function(){var that=this,suggestionSelector="."+that.classes.suggestion,selected=that.classes.selected,options=that.options,container;that.element.setAttribute("autocomplete","off");that.noSuggestionsContainer=$('<div class="autocomplete-no-suggestion"></div>').html(this.options.noSuggestionNotice).get(0);that.initialSuggestions=this.options.initialSuggestions;that.suggestionsContainer=$.Autocomplete.utils.createNode(options.containerClass);container=$(that.suggestionsContainer);container.appendTo(options.appendTo||"body");if(options.width!=="auto"){container.css("width",options.width)}container.on("mouseover.autocomplete",suggestionSelector,function(){that.activate($(this).data("index"))});container.on("mouseout.autocomplete",function(){that.selectedIndex=-1;container.children("."+selected).removeClass(selected)});container.on("click.autocomplete",suggestionSelector,function(){that.select($(this).data("index"))});container.on("click.autocomplete",function(){clearTimeout(that.blurTimeoutId)});that.fixPositionCapture=function(){if(that.visible){that.fixPosition()}};this.setListeners()},hide:function(callback){var that=this,container=$(that.suggestionsContainer);if($.isFunction(that.options.onHide)&&that.visible){that.options.onHide.call(that.element,container)}that.visible=false;that.selectedIndex=-1;clearTimeout(that.onChangeTimeout);container.slideUp(275,function(){this.classList.remove("autocomplete-suggestions--is-open");DL.Utils.Events.dispatchEvent("autocomplete-hide",that.element);if(callback&&_.isFunction(callback)){callback()}});that.signalHint(null)},suggest:function(suggestions){if(!this.suggestions.length&&_.isUndefined(suggestions)){if(this.options.showNoSuggestionNotice){this.noSuggestions()}else{this.hide()}return}if(!_.isUndefined(suggestions)){this.suggestions=suggestions}var that=this,options=that.options,groupBy=options.groupBy,formatResult=options.formatResult,value=that.getQuery(that.currentValue),className=that.classes.suggestion,classSelected=that.classes.selected,container=$(that.suggestionsContainer),noSuggestionsContainer=$(that.noSuggestionsContainer),beforeRender=options.beforeRender,html="",category,formatGroup=function(suggestion,index){var currentCategory=suggestion.data[groupBy];if(category===currentCategory){return""}category=currentCategory;return options.formatGroup(suggestion,category)};if(options.triggerSelectOnValidInput&&that.isExactMatch(value)){that.select(0);return}$.each(this.suggestions,function(i,suggestion){if(groupBy){html+=formatGroup(suggestion,value,i)}html+='<div class="'+className+'" data-index="'+i+'">'+formatResult(suggestion,value,i)+"</div>"});this.adjustContainerWidth();noSuggestionsContainer.detach();container.html(html);if($.isFunction(beforeRender)){beforeRender.call(that.element,container,that.suggestions)}that.fixPosition();container.slideDown(275,function(){this.classList.add("autocomplete-suggestions--is-open");DL.Utils.Events.dispatchEvent("autocomplete-open",that.element)});if(options.autoSelectFirst){that.selectedIndex=0;container.scrollTop(0);container.children("."+className).first().addClass(classSelected)}that.visible=true;that.findBestHint()}});DL.Autocomplete={list:function(){$.post(this.ajaxUrl,this.args,this.act)},cleanJsonData:function(json){return _.map(json,function(item){item.value+="";return item})},removeTypeFromJson:function(type,container){return container.filter(function(item){return type!==item.data.type})},act:function(data){if(_.isUndefined(data)){return}if(_.isUndefined(data.data)){return}try{var jsonData=JSON.parse(data.data);jsonData.suggestions=this.cleanJsonData(jsonData.suggestions);jsonData.initial=this.cleanJsonData(jsonData.initial);if("term"===this.field.getAttribute("data-exclude")){jsonData.initial=this.removeTypeFromJson("term",jsonData.initial);jsonData.suggestions=this.removeTypeFromJson("term",jsonData.suggestions)}$(this.field).autocomplete({lookup:jsonData.suggestions,minChars:3,showNoSuggestionNotice:false,triggerSelectOnValidInput:false,appendTo:this.wrapper,onHide:this.onHide,beforeRender:this.beforeRender,onHint:this.onHint,onSelect:this.onSelect,formatResult:this.formatResult,initialSuggestions:jsonData.initial})}catch(e){"dev"===window.dllocalized.env&&console.warn(e);return false}},onHide:function(){DL.Utils.Events.dispatchEvent("autocomplete-on-hide",this.field)},beforeRender:function(){DL.Utils.Events.dispatchEvent("autocomplete-on-open",this.field)},onHint:function(hint){this.hintEl.innerHTML=hint},onSelect:function(suggestion){if(typeof suggestion.data!=="undefined"){var form=this.field.form;if(!form.querySelector("#dlautocomplete_context")){var input=document.createElement("input");input.setAttribute("name","dlautocomplete_context");input.setAttribute("id","dlautocomplete_context");input.setAttribute("type","hidden");form.appendChild(input)}if(!form.querySelector("#qibla_event_categories_filter")){input=document.createElement("input");input.setAttribute("name","qibla_event_categories_filter");input.setAttribute("id","qibla_event_categories_filter");input.setAttribute("type","hidden");input.setAttribute("value",suggestion.value);form.appendChild(input)}if(!_.isUndefined(suggestion.data.permalink)){form.setAttribute("action",suggestion.data.permalink)}form.querySelector("#dlautocomplete_context").value=JSON.stringify(suggestion.data)}},formatResult:function(suggestion,currentValue){var pattern,suggestionText=suggestion.value;if(currentValue){pattern="("+$.Autocomplete.utils.escapeRegExChars(currentValue)+")";suggestionText=suggestion.value.replace(new RegExp(pattern,"gi"),"<strong>$1</strong>").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/&lt;(\/?strong)&gt;/g,"<$1>")}var iconClassAttribute=!_.isUndefined(suggestion.data.icon)?suggestion.data.icon.icon_html_class:"la la-check";var suggestionMarkup='<i class="'+iconClassAttribute+'"></i>';suggestionMarkup+='<span class="suggestion__content">'+suggestionText+"</span>";return suggestionMarkup},createHintEl:function(){this.hintEl=document.createElement("span");this.hintEl.setAttribute("class","hint");this.wrapper.insertBefore(this.hintEl,this.field.nextElementSibling);this.wrapper.querySelector("input").style.background="transparent"},init:function(){if(!this.wrapper.querySelector(".hint")){this.createHintEl()}return this},construct:function(field,data){_.bindAll(this,"list","act","onHide","beforeRender","onHint","onSelect","formatResult","createHintEl","removeTypeFromJson");if(!field){return}this.field=field;this.wrapper=field.parentNode;this.args={autocomplete:1,action:"get",data:data,dlajax_action:"autocomplete",dataType:"json",timeout:300};this.ajaxUrl=window.dllocalized.site_url+"/index.php";return this}};DL.AutocompleteFactory=function(field,type){return Object.create(DL.Autocomplete).construct(field,type)};window.addEventListener("load",function(){_.forEach(document.querySelectorAll(".use-autocomplete"),function(field){var data=field.getAttribute("data-autocomplete"),instance=DL.AutocompleteFactory(field,data);instance&&instance.init().list()})})})(window._,window.jQuery,window.DL,window.dllocalized);