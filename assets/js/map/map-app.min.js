window.DlMap=window.DlMap||{};(function(_,Backbone,google,dlgooglemap,DlMap,DlListings,dllocalized){"use strict";function getDefaultMapCenter(){var defaultCenter=new google.maps.LatLng(21.4010244,-157.9784046);if(!_.isUndefined(window.dlgooglemap.center.lat)&&!_.isUndefined(window.dlgooglemap.center.lng)){defaultCenter=new google.maps.LatLng(window.dlgooglemap.center.lat,window.dlgooglemap.center.lng)}return defaultCenter}document.addEventListener("DOMContentLoaded",function(){DlMap.STYLE=function(style){try{if(!_.isEmpty(window.dlgooglemap.style)){style=_.union(style,JSON.parse(window.dlgooglemap.style))}}catch(e){console.warn("Qibla: Json Map Style cannot be set.")}return style}([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]}]);DlMap.Map=function(el,options){_.defaults(options,{zoom:window.dlgooglemap.zoom,maxZoom:17,center:getDefaultMapCenter(),disableDoubleClickZoom:true,disableDefaultUI:true,gestureHandling:"greedy",scrollwheel:true,zoomControl:true,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT},styles:DlMap.STYLE});google.maps.Map.apply(this,[el,options])};DlMap.Map.prototype=Object.create(google.maps.Map.prototype,{openedInfoWindows:{value:[],writable:true,enumerable:true},closeOpenedInfoWindows:{value:function(){if(!this.openedInfoWindows.length){return}for(var c=0;c<this.openedInfoWindows.length;++c){this.openedInfoWindows[c].remove()}this.openedInfoWindows=[]}},getBoundsByMakers:{value:function(markers){if(!markers){markers=DlMap.markerCollection.getMarkerRefs()||[]}var bounds=new google.maps.LatLngBounds;_.forEach(markers,function(marker){bounds.extend(marker.getPosition())});return bounds}},panAndZoom:{value:function(latLng,zoom){this.panTo(latLng);this.setZoom(zoom);return this}},reCenter:{value:function(){clearTimeout(reCenter);var reCenter=setTimeout(function(){var bounds=this.getBoundsByMakers();this.fitBounds(bounds);this.setCenter(bounds.getCenter())}.bind(this),300);return this}},dispatchEvent:{value:function(event){switch(event){case"resize":google.maps.event.trigger(this,"resize");break;default:break}return this}},setEvents:{value:function(){this.addListener("zoom_changed",this.closeOpenedInfoWindows.bind(this));this.addListener("resize",this.reCenter.bind(this));google.maps.event.addDomListener(window,"resize",this.reCenter.bind(this));google.maps.event.addDomListener(this,"mousedown",this.closeOpenedInfoWindows.bind(this))}}});DlMap.Backbone={};DlMap.Backbone.Models={Marker:Backbone.Model.extend({constructor:function(item){this.infoWindow=new DlMap.Backbone.Views.InfoWindow({model:this});this.marker=new CustomMarker(new google.maps.LatLng(item.location.latLng[0],item.location.latLng[1]),{dataMarkerSlug:item.slug,templateData:item},_.template(document.querySelector("#dltmpl_map_marker").innerHTML));Backbone.Model.call(this,item)},initialize:function(){google.maps.event.addListener(this.marker,"click",this.onClick.bind(this))},onClick:function(e){e.preventDefault();e.stopPropagation();this.trigger("click");return this}})};DlMap.Backbone.Views={InfoWindow:Backbone.View.extend({el:null,template:function(){var template=document.querySelector("#dltmpl_map_info_window");if(!template){template=""}else{template=template.innerHTML}return _.template(template)}(),constructor:function(){this.infoBox=new InfoBox({closeBoxURL:false,boxClass:"dlmap-info-window dlmap-info-window--default animated fadeIn",infoBoxClearance:new google.maps.Size(64,64),pixelOffset:new google.maps.Size(-117,-62),alignBottom:true});Backbone.View.apply(this,arguments)},initialize:function(){_.bindAll(this,"render");this.model.on("click",this.render);this.model.on("remove",this.remove)},render:function(){if(!DlMap.map){return this}if(DlMap.map.openedInfoWindows.length){var iwName=DlMap.map.openedInfoWindows[0].model.get("slug");if(iwName===this.model.get("slug")){return}}DlMap.map.closeOpenedInfoWindows();this.infoBox.setContent(this.template(this.model.attributes));this.infoBox.setPosition(this.model.marker.getPosition());this.infoBox.open(DlMap.map);DlMap.map.openedInfoWindows.push(this);return this},remove:function(){this.infoBox.close();Backbone.View.prototype.remove.apply(this,arguments)}})};DlMap.Backbone.Collections={Marker:Backbone.Collection.extend({getMarkerRefs:function(){return _.pluck(this.models,"marker")},initialize:function(){_.bindAll(this,"cleanMarkers");this.on("reset",this.cleanMarkers)},cleanMarkers:function(){if(DlMap.map.markerCluster){DlMap.map.markerCluster.clearMarkers();DlMap.map.markerCluster=null}}})}})})(_,Backbone,google,window.dlgooglemap,window.DlMap,window.DlListings,window.dllocalized);