window.DL=window.DL||{},window.DlMap=window.DlMap||{},window.DlListings=window.DlListings||{},function(o,l,t,e,i,r,a,s,n,c,d,u){"use strict";u.Listings=u.Listings||{},u.Listings.Filter={listingsListEl:function(){return document.querySelector(".dllistings-list")},useMap:function(){return Boolean(u.Utils.Functions.classList(document.body).contains("dl-is-listings--with-map"))},useScMap:function(){var t=document.getElementById("dlgoogle-map");return!!t&&Boolean(u.Utils.Functions.classList(t).contains("dlsc-map"))},visibleMap:function(){return window.dllistings.mapVisible||this.useScMap()},getFormTriggers:function(){return this.form.querySelectorAll(".dllistings-ajax-filter-trigger")},updateMap:function(){a.map.reCenter(),a.map.setEvents()},buildAutoupdateList:function(){if(l.isEmpty(this.autoUpdate)){var t=this.form.querySelectorAll(".is-autoupdate");t&&l.forEach(t,function(t){var e=u.Utils.String.toSlug(t.getAttribute("data-autoupdate"));e&&(this.autoUpdate[e]={instance:t,filter:t.getAttribute("data-autoupdate")})}.bind(this))}},updateAutoupdateFiltersMarkup:function(t){l.isEmpty(t)||(l.forEach(t,function(t,e){l.isUndefined(this.autoUpdate[e])||(this.autoUpdate[e].instance.innerHTML=t)}.bind(this)),u.Listings.FilterToggler.counterChecked(),u.Listings.FilterToggler.updateCheckboxCounter())},postData:function(t){var i="dlajax_action=listings_filter&"+o(this.form).serialize();l.isEmpty(this.autoUpdate)&&this.buildAutoupdateList(),l.forEach(this.autoUpdate,function(t,e){i+="&auto_update_filters["+t.filter+"]=1"}),l.isFunction(t)&&t(i)},init:function(){this.visibleMap()&&(a.map=new a.Map(document.querySelector("#dlgoogle-map"),window.dlgooglemap),a.markerCollection=new a.Backbone.Collections.Marker(null,{model:a.Backbone.Models.Marker})),this.archiveDescriptionModel=new s.Backbone.Models.ArchiveDescription,this.archiveDescriptionView=new s.Backbone.Views.ArchiveDescription({model:this.archiveDescriptionModel}),this.foundPostsModel=new s.Backbone.Models.FoundPosts,this.foundPostsView=new s.Backbone.Views.FoundPosts({model:this.foundPostsModel}),this.paginationModel=new s.Backbone.Models.Pagination,this.paginationView=new s.Backbone.Views.Pagination({model:this.paginationModel}),this.listingsCollection=new s.Backbone.Collections.Listings(null,{model:s.Backbone.Models.Listings}),l.isEmpty(d)||l.isEmpty(d.posts)||(this.listingsCollection.add(d.posts),this.visibleMap()&&(a.markerCollection.add(d.posts),a.map.markerCluster=new r(a.map,a.markerCollection.getMarkerRefs(),{gridSize:50,maxZoom:15,minimumClusterSize:2,ignoreHidden:!0},l.template(document.querySelector("#dltmpl_map_markerclusterer").innerHTML)),this.updateMap()),this.setPagionationAjaxTrigger(),window.jsonListings=void 0),this.setTriggers()},setPagionationAjaxTrigger:function(){var t,i=this,e=document.querySelector(".dlpagination");e&&(t=e.querySelectorAll("a.page-numbers")).length&&l.forEach(t,function(t){t.addEventListener("click",function(t){t.preventDefault(),clearTimeout(e);var e=setTimeout(function(){i.filter(t)},0)})})},setTriggers:function(){if(this.useMap()||!this.useScMap()){if(void 0===this.form||null===this.form)throw"Invalid form element when set triggers.";this.form.addEventListener("submit",this.filter.bind(this)),this.form.addEventListener("reset",this.filter.bind(this)),l.forEach(this.getFormTriggers(),function(t){var e;switch(t.nodeName){case"SELECT":e="select2change","qibla_"+t.getAttribute("data-taxonomy")+"_filter"===t.getAttribute("id")&&function(t,e){t.addEventListener(e,function(){var t=this.form.querySelectorAll(".geocode-input");t.length&&l.forEach(t,function(t){t.remove()});var e=this.form.querySelector("#geocode_nonce");e&&e.remove()}.bind(this))}.call(this,t,"select2change");break;case"INPUT":e="change";break;default:e="click"}t.addEventListener(e,this.filter.bind(this))}.bind(this))}},noPostsFound:function(t){var e=this.listingsListEl().firstElementChild;e&&(e.innerHTML=t)},toggleElementsWhenFetching:function(){var t=document.querySelector(".dlarchive-description"),e=document.querySelector(".dlarchive-listings-footer");e&&u.Utils.Functions.classList(e).toggle("is-hidden"),t&&u.Utils.Functions.classList(t).toggle("is-hidden")},updateListingsContainerBoxModel:function(t){var e=function(t){this.listingsListEl().style.height=t}.bind(this),i=function(){0===--n&&e("auto")};if(!this.visibleMap())if(t)e(this.listingsListEl().firstElementChild.clientHeight+"px");else{var s=this.listingsListEl().querySelectorAll("img"),n=s.length;l.forEach(s,function(t){t.complete?i():o(t).load(i)}.bind(this))}},filter:function(n){var t=this.ajaxUrl;if(!(n instanceof Event&&("reset"!==n.type&&(n.preventDefault(),n.stopPropagation()),n.target.classList.contains("page-numbers")?t=n.target.getAttribute("href"):"I"===n.target.tagName&&n.target.parentNode.classList.contains("page-numbers")&&(t=n.target.parentNode.getAttribute("href")),"select2change"===n.type&&this.form.classList.contains("dlform-filter--open")))){this.listingsCollection.url=t;var e=document.body.classList.contains("is-safari")||document.body.classList.contains("is-edge")||document.body.classList.contains("is-mobile")?"body":"html";o(e).animate({scrollTop:0},function(){this.listingsListEl()&&u.Utils.UI.toggleLoader(this.listingsListEl().firstElementChild),this.postData(function(t){this.listingsCollection.fetch({type:"post",reset:!0,silent:!1,data:t,beforeSend:function(){u.Utils.Events.dispatchEvent("listings-collection-fetching",this.form,null,{obj:this,eventParent:n}),this.toggleElementsWhenFetching(),this.updateListingsContainerBoxModel(!0)}.bind(this),complete:function(){u.Utils.Events.dispatchEvent("listings-collection-fetched",this.form,null,{obj:this,eventParent:n}),this.listingsListEl().lastElementChild.classList.contains("ajax-loader")&&u.Utils.UI.toggleLoader(this.listingsListEl().firstElementChild,function(){this.updateListingsContainerBoxModel(),this.toggleElementsWhenFetching()}.bind(this))}.bind(this),success:function(t,e,i){if(t.models&&(u.Listings.Filter.visibleMap()&&a.markerCollection.reset(),l.forEach(t.models,function(t){t.trigger("update"),u.Listings.Filter.visibleMap()&&a.markerCollection.add(t.attributes)})),u.Utils.Events.dispatchEvent("listings-collection-success-fetched",this.form,null,{obj:this,eventParent:n}),e.foundPosts.number){var s=document.querySelector(".dlnocontent-found-listings");s&&s.remove(),u.Listings.Filter.visibleMap()&&(a.map.markerCluster=new r(a.map,a.markerCollection.getMarkerRefs(),{gridSize:50,maxZoom:15,minimumClusterSize:2,ignoreHidden:!0},l.template(document.querySelector("#dltmpl_map_markerclusterer").innerHTML)),this.updateMap())}else this.noPostsFound(e.noContentFoundTemplate);this.foundPostsModel.set(e.foundPosts),this.archiveDescriptionModel.set(e.archiveDescription),this.paginationModel.set(e.pagination),this.setPagionationAjaxTrigger(),"autoUpdateFilters"in e&&this.updateAutoupdateFiltersMarkup(e.autoUpdateFilters)}.bind(this)})}.bind(this))}.bind(this))}},construct:function(t,e,i){if(l.bindAll(this,"getFormTriggers","updateMap","postData","init","setPagionationAjaxTrigger","setTriggers","noPostsFound","toggleElementsWhenFetching","filter","updateListingsContainerBoxModel","updateAutoupdateFiltersMarkup","buildAutoupdateList"),i||this.useMap()||this.useScMap())return i&&(this.ajaxUrl=t,this.form=i,this.userPosition=e,this.data=null,this.autoUpdate={}),this}},u.Listings.FilterFactory=function(t,e,i){return Object.create(u.Listings.Filter).construct(t,e,i)},u.Listings.FilterToggler={useMap:function(){return Boolean(u.Utils.Functions.classList(document.body).contains("dl-is-listings--with-map"))},useScMap:function(){var t=document.getElementById("dlgoogle-map");return!!t&&Boolean(u.Utils.Functions.classList(t).contains("dlsc-map"))},visibleMap:function(){return window.dllistings.mapVisible||this.useScMap()},toggle:function(t){var e=this;"A"===t.target.tagName&&(t.preventDefault(),t.stopImmediatePropagation()),this.actions.style.display="none",o(this.filters).slideToggle(375,function(){if(e.isOpen=!e.isOpen,e.isOpen?(e.form.classList.add("dlform-filter--open"),e.actions.style.display="block"):e.form.classList.remove("dlform-filter--open"),this.style.overflowY="scroll",e.useMap()&&(e.form.parentElement.style.overflowY="hidden"),e.isOpen){var t=e.container.querySelector("#dltogglers");t&&(t=e.container.querySelector("#dltogglers").clientHeight)}else this.style.overflowY="auto",e.useMap()&&(e.form.parentElement.style.overflowY="auto")})},updateCheckboxCounter:function(){var t=document.querySelectorAll("[type=checkbox]:checked"),e=document.querySelector("#dltoggler_filters > span");0<t.length?e.innerText=t.length:e.innerText=""},counterChecked:function(){l.forEach(document.querySelectorAll("[type=checkbox]"),function(t){t.addEventListener("change",function(){u.Listings.FilterToggler.updateCheckboxCounter()})})},clearFilters:function(t){t&&(t.preventDefault(),t.stopPropagation()),this.form.reset();var e=this.form.querySelectorAll("select");e.length&&l.forEach(e,function(t){t.setAttribute("selected",t.firstElementChild.getAttribute("value")),u.Utils.Events.dispatchEvent("change",t)})},init:function(){var t=this.form.querySelector("#dltoggler_filters");return t&&t.addEventListener("click",this.toggle),this.updateBtn.addEventListener("click",this.toggle),this.clearBtn.addEventListener("click",this.toggle),this.counterChecked(),this.updateCheckboxCounter(),this},construct:function(){if(l.bindAll(this,"init","useMap","useScMap","visibleMap","toggle","clearFilters","updateCheckboxCounter","counterChecked"),this.isOpen=!1,!this.useScMap()&&(this.form=document.querySelector(".dlform-filter"),this.form&&(this.filters=this.form.querySelector(".dlform-filter__hidden-fields"),this.filters)))return this.container=document.querySelector("#dllistings_toolbar"),this.actions=this.filters.querySelector(".dlform-filter__actions"),this.updateBtn=this.form.querySelector(".dlform-filter__action--update"),this.clearBtn=this.form.querySelector(".dlform-filter__action--clear"),this}},u.Listings.FilterTogglerFactory=function(){return Object.create(u.Listings.FilterToggler).construct()},window.addEventListener("load",function(){var t=u.Listings.FilterFactory(window.dllistings.listingsAjaxUrl,u.Geo.UserPositionFactory(),document.getElementById("dlform_filter"));t&&t.init();var e=u.Listings.FilterTogglerFactory();e&&e.init()})}(jQuery,_,window.dllocalized,Backbone,window.google,window.CustomMarkerClusterer,window.DlMap,window.DlListings,window.dllistings,window.dlgooglemap,window.jsonListings,window.DL);