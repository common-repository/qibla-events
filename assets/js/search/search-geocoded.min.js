window.DL=window.DL||{};(function(_,$,google,dlnavGeocodeSuggestions,dllocalized,DL){"use strict";DL.Search=DL.Search||{};DL.Search.Geocoded={createLocationFormHiddenFields:function(){if(_.isEmpty(this.location)){return}for(var prop in this.location){if(this.location.hasOwnProperty(prop)){var el=document.createElement("input");el.setAttribute("type","hidden");el.setAttribute("id","geocoded_hidden_data");el.setAttribute("name","geocoded["+prop+"]");el.value=this.location[prop];this.form.appendChild(el)}}},deleteLocationFormHiddenFields:function(){var hidden=this.form.querySelector("geocoded_hidden_data");if(hidden){hidden.remove()}},submit:function(evt){evt.preventDefault();evt.stopImmediatePropagation();var _submit=function(){var taxFrag=this.input.getAttribute("data-taxonomy");taxFrag=taxFrag?"/"+taxFrag+"/":"";if(!this.predictioner.isGeocodeSuggestion()){this.predictioner.createLocationFilterFormField(evt.target);this.deleteLocationFormHiddenFields();this.form.setAttribute("action",window.dllocalized.site_url+taxFrag+encodeURI(DL.Utils.String.toSlug(this.input.value)))}else{this.predictioner.deleteLocationFilterFormField(evt.target);this.createLocationFormHiddenFields()}evt.target.submit()}.bind(this);if(this.input.value&&this.predictioner.isGeocodeSuggestion()){DL.Geo.GeocodeFactory(this.input.value,false).geocode(function(data){this.location=data;_submit()}.bind(this),function(data){"dev"===window.dllocalized.env&&console.warn(data);_submit()}.bind(this))}else{this.location={};_submit()}},init:function(){this.predictioner&&this.predictioner.initUsing(this.input);DL.Utils.Events.addListener(this.form,"submit",this.submit,{capture:true});var userGeolocatorTrigger=this.form.querySelector(".dlgeolocalization-trigger");if(userGeolocatorTrigger){DL.Utils.Events.addListener(userGeolocatorTrigger,"click",this.geocodeUserPosition,{capture:true},{form:this.form})}return this},geocodeUserPosition:function(evt,instance){evt.preventDefault();evt.stopImmediatePropagation();DL.Utils.UI.toggleLoader(evt.target);this.userPosition.currentPosition(function(){this.location={lat:this.userPosition.lat(),lng:this.userPosition.lng()};try{DL.Geo.GeocodeFactory({lat:this.userPosition.lat(),lng:this.userPosition.lng()},true).geocode(function(data){if(!this.input){return}this.input.value=data.address;DL.Utils.Events.dispatchEvent("change",this.input,null,{geocode:data});DL.Utils.UI.toggleLoader(evt.target)}.bind(this))}catch(e){"dev"===window.dllocalized.env&&console.warn(e)}}.bind(this),function(){DL.Utils.UI.toggleLoader(evt.target)}.bind(this))},construct:function(form,userPosition,predictioner){_.bindAll(this,"init","createLocationFormHiddenFields","deleteLocationFormHiddenFields","geocodeUserPosition","submit");this.location=null;this.userPosition=userPosition;this.form=form;this.input=this.form.querySelector(".is-geocoded");this.predictioner=predictioner;return this}};DL.Search.GeocodedFactory=function(form,userPositioner,predictioner){return Object.create(DL.Search.Geocoded).construct(form,userPositioner,predictioner)};var GooglePredictions={navSearchListEl:function(){return this.input.parentNode.querySelector(".dlnav-search .dlnav-search__list-items")},clean:function(){this.cleanTemplate();this.items="";this.predictions=[];this.suggestionType="";return this},updateNavheight:function(nav){if(!nav){return}nav.style.height=_.reduce(nav.querySelectorAll(".menu-item"),function(r,v){return r+=v.offsetHeight},0)+"px"},hide:function(callback){var nav=this.input.parentNode.querySelector(".dlnav-search");if(nav){$(nav).slideUp(275,function(){this.searchIsOpen=false;DL.Utils.Functions.classList(nav).remove("dlnav-search--is-open");if(""===this.input.value){this.clean()}if(_.isFunction(callback)){callback()}}.bind(this))}return this},show:function(callback){var nav;if(this.items){nav=this.input.parentNode.querySelector(".dlnav-search")}if(nav){$(nav).slideDown(275,function(){this.searchIsOpen=true;DL.Utils.Functions.classList(nav).add("dlnav-search--is-open");if(_.isFunction(callback)){callback()}_.forEach(this.navSearchListEl().querySelectorAll(".menu-item"),function(item){DL.Utils.Events.addListener(item,"click",this.setValueByEvent.bind(this,item),{capture:true,once:true})}.bind(this));this.updateNavheight(nav)}.bind(this))}return this},render:function(){if(this.items){this.cleanTemplate(function(){var nav=this.navSearchListEl(),template=_.template(nav.innerText);if(!template){throw"Cannot compile navigation template for geocode predictions."}var compiled=template({items:this.items});if(compiled){nav.innerHTML=compiled}this.show()}.bind(this))}return this},renderSuggestions:function(){if(this.predictions.length){return}if(!this.suggestionsCache){var itemsMarkup="";_.forEach(dlnavGeocodeSuggestions,function(item){itemsMarkup+='<li class="menu-item" data-label="'+item.label+'" data-suggestion-type="static"><a href="#"><i class="'+item.icon+'"></i>'+item.label+"</a></li>"});this.suggestionsCache=itemsMarkup}this.items=this.suggestionsCache;this.render()},cleanTemplate:function(callback){this.input.parentNode.querySelector(".dlnav-search .dlnav-search__list-items").innerText="<%= items %>";if(_.isFunction(callback)){callback()}return this},createTemplate:function(){if(this.input.parentNode.querySelector(".dlnav-search")){return}var element=document.querySelector("#dlnavigation-tmpl");element&&this.input.parentNode.insertAdjacentHTML("beforeend",element.innerHTML);return this},createItems:function(){this.items="";if(this.predictions.length){_.forEach(this.predictions,function(prediction){this.items+='<li class="menu-item" data-label="'+prediction.description+'" data-suggestion-type="google"><a href="#"><i class="la la-map-marker"></i>'+prediction.description+"</a></li>"}.bind(this))}return this},handleInputKeyDown:function(evt){switch(evt.keyCode){case 27:this.hide();break;case 13:case 38:case 39:case 40:this.navigateThroughItems(evt.keyCode);if(13===evt.keyCode&&this.searchIsOpen){evt.preventDefault();evt.stopImmediatePropagation()}break;default:if(""===this.input.value&&!this.predictions.length){break}if(""===this.input.value){this.hide(this.renderSuggestions);break}this.googleAutocomplete.getPlacePredictions({input:this.input.value},this.predict);break}},setValue:function(value,type){if(value){this.input.value=value;this.suggestionType=type}},setValueByEvent:function(item,evt){evt.preventDefault();evt.stopImmediatePropagation();this.setValue(evt.target.parentNode.getAttribute("data-label"),item.getAttribute("data-suggestion-type"))},isGeocodeSuggestion:function(){return"static"!==this.suggestionType},createLocationFilterFormField:function(form){var el=document.createElement("input");el.setAttribute("type","hidden");el.setAttribute("id","qibla_"+this.input.getAttribute("data-taxonomy")+"_filter");el.setAttribute("name","qibla_"+this.input.getAttribute("data-taxonomy")+"_filter");el.value=this.input.value;form.appendChild(el)},deleteLocationFilterFormField:function(form){var hidden=form.querySelector("qibla_"+this.input.getAttribute("data-taxonomy")+"_filter");if(hidden){hidden.remove()}},predict:function(predictions,status){if(_.isEmpty(predictions)||status!==google.maps.places.PlacesServiceStatus.OK){this.cleanTemplate().hide();return false}this.predictions=predictions;this.createItems().render()},navigateThroughItems:function(keyCode){if(!this.searchIsOpen){return}var searchNav=this.navSearchListEl(),currItem=searchNav.querySelector(".is-selected"),nextCurrentItem=null;if(!currItem){DL.Utils.Functions.classList(searchNav.firstElementChild).add("is-selected");this.setValue(searchNav.firstElementChild.getAttribute("data-label"),searchNav.firstElementChild.getAttribute("data-suggestion-type"));return}switch(keyCode){case 38:case 40:if(40===keyCode&&currItem===searchNav.lastElementChild){break}if(38===keyCode&&currItem===searchNav.firstElementChild){this.input.value="";break}DL.Utils.Functions.classList(currItem).remove("is-selected");if(40===keyCode){nextCurrentItem=currItem.nextElementSibling}if(38===keyCode){nextCurrentItem=currItem.previousElementSibling}nextCurrentItem&&DL.Utils.Functions.classList(nextCurrentItem).add("is-selected");this.setValue(nextCurrentItem.getAttribute("data-label"),nextCurrentItem.getAttribute("data-suggestion-type"));currItem=nextCurrentItem;nextCurrentItem=null;break;case 39:if(this.input.value){this.hide()}break;case 13:if(this.input.value){this.hide()}break}},initUsing:function(input){if(!input){return}if(this.googleAutocomplete instanceof google.maps.places.AutocompleteService){this.input=input;this.createTemplate();DL.Utils.Events.addListener(this.input,"keydown",this.handleInputKeyDown);DL.Utils.Events.addListener(this.input,"blur",this.hide);DL.Utils.Events.addListener(this.input,["click","focus"],this.renderSuggestions);DL.Utils.Events.addListener(this.input,"focus",this.show)}},construct:function(){_.bindAll(this,"initUsing","cleanTemplate","createItems","predict","render","hide","show","renderSuggestions","navigateThroughItems","setValueByEvent","handleInputKeyDown","createLocationFilterFormField","deleteLocationFilterFormField");if(false==="AutocompleteService"in google.maps.places){return false}this.input=null;this.googleAutocomplete=new google.maps.places.AutocompleteService;this.predictions=[];this.items="";this.searchIsOpen=false;this.suggestionType="";return this}};var GooglePredictionsFactory=function(){return Object.create(GooglePredictions).construct()};window.addEventListener("load",function(){setTimeout(function(){var forms=document.querySelectorAll(".dlsearch__form");_.forEach(forms,function(form){var geocodedField=form.querySelector(".is-geocoded");if(geocodedField){var geocoded=DL.Search.GeocodedFactory(form,DL.Geo.UserPositionFactory(),GooglePredictionsFactory());geocoded&&geocoded.init()}})},0)})})(_,window.jQuery,window.google,window.dlnavGeocodeSuggestions,window.dllocalized,window.DL);